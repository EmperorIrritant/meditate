#!/bin/bash

trap display_time INT

function display_time() {
  diff=$SECONDS
  tput cub 2 #To clear the "^C" characters printed on pressing Ctrl+C
  echo "Full breath cycles: $count"
  echo "Meditation Time: $(($diff / 3600)) hours, $((($diff / 60) % 60)) minutes and $(($diff % 60)) seconds"
  exit
}

usage="Usage: ./$(basename $0) [OPTIONS]

Options:
 -p <player>      vlc, mpv, ffplay
 -t <seconds>     set meditation timer (default: infinite)
 -h               this help"

error_msg="Illegal usage. Try $(basename $0) -h for usage."

while getopts ":hp:t:" opt; do
  case "${opt}" in
    h)
      echo "$usage"
      exit 0
      ;;
    p)
      PLAYEROPTION=("$OPTARG")
      if [[ "${#PLAYEROPTION[@]}" -gt 1 ]];
      then
        PLAYER="$OPTARG"
      else
        case "$OPTARG" in
          # TODO: Check if selected players exist
          vlc)
            PLAYER="vlc --intf dummy --no-loop --play-and-exit --quiet --no-version"
            ;;
          mpv)
            PLAYER="mpv --no-terminal"
            ;;
          ffplay)
            PLAYER="ffplay -nodisp -autoexit"
            ;;
          *)
          echo "$error_msg"
          exit 0
        esac
      fi
      ;;
    t)
      # Not implemented yet
      TIMER="$OPTARG"
      ;;
    ?)
      echo "$error_msg"
      exit 0
      ;;
  esac
done

#if [[ -z "$TIMER" ]];
#then
#  if [ ! -t 0 ] && [ ! -t 1 ]; then
#    exit -1;
#  echo
#  fi
#fi

FPATH=.
INHALE="$FPATH"/Inhale.mp3
HOLD="$FPATH"/Hold.mp3
EXHALE="$FPATH"/Exhale.mp3

INHALETIME=6
INHALEHOLDTIME=4
EXHALETIME=7
EXHALEHOLDTIME=3

if [[ -z "$PLAYER" ]];
then
  exit -1;
fi;

count=0
SECONDS=0
while sleep $EXHALEHOLDTIME;
do
  count=$((count+1));
  $PLAYER $INHALE >&- 2>&-;
  sleep $INHALETIME;
  $PLAYER $HOLD >&- 2>&-;
  sleep $INHALEHOLDTIME;
  $PLAYER $EXHALE >&- 2>&-;
  sleep $EXHALETIME;
  $PLAYER $HOLD >&- 2>&-;
done