#!/bin/bash

SECONDS=0

trap display_time INT

function display_time() {
  diff=$SECONDS
  tput cub 2 #To clear the "^C" characters printed on pressing Ctrl+C
  echo "Full breath cycles: $count"
  echo "Meditation Time: $(($diff / 3600)) hours, $((($diff / 60) % 60)) minutes and $(($diff % 60)) seconds"
  exit
}

usage="Usage: ./$(basename $0) [OPTIONS]

Options:
 -p <player>      vlc, mpv
 -h               this help"

error_msg="Illegal usage. Try $(basename $0) -h for usage."

while getopts ":hp:" opt; do
  case "${opt}" in
    h)
      echo "$usage"
      exit 0
      ;;
    p)
      PLAYEROPTION=("$OPTARG")
      if [[ "${#PLAYEROPTION[@]}" -gt 1 ]];
      then
        PLAYER="$OPTARG"
      else
        case "$OPTARG" in
          vlc)
            PLAYER="vlc --intf dummy --no-loop --play-and-exit --quiet --no-version"
            ;;
          mpv)
            PLAYER="mpv --no-terminal"
            ;;
          *)
          echo "$error_msg"
          exit 0
        esac
      fi
      ;;
    ?)
      echo "$error_msg"
      exit 0
      ;;
  esac
done

# Unnecessary shift. To be removed.
shift $((OPTIND-1))

FPATH=.
INHALE="$FPATH"/Inhale.mp3
HOLD="$FPATH"/Hold.mp3
EXHALE="$FPATH"/Exhale.mp3

INHALETIME=6
INHALEHOLDTIME=4
EXHALETIME=7
EXHALEHOLDTIME=3

count=0

while sleep $EXHALEHOLDTIME;
do
  count=$((count+1));
  $PLAYER $INHALE >&- 2>&-;
  sleep $INHALETIME;
  $PLAYER $HOLD >&- 2>&-;
  sleep $INHALEHOLDTIME;
  $PLAYER $EXHALE >&- 2>&-;
  sleep $EXHALETIME;
  $PLAYER $HOLD >&- 2>&-;
done